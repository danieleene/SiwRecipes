<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Modifica Ricetta</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>

<div class="page-wrapper">
    <div class="form-card">

        <h1 class="form-title">Modifica Ricetta</h1>

        <form th:action="@{'/ricetta/' + ${ricetta.id} + '/edit'}"
              th:object="${ricetta}" method="post" class="form-content">

            <!-- TITOLO -->
            <div class="form-group">
                <label for="titolo">Titolo</label>
                <input type="text" id="titolo" th:field="*{titolo}" required />
            </div>

            <!-- DESCRIZIONE -->
            <div class="form-group">
                <label for="descrizione">Descrizione</label>
                <textarea id="descrizione" th:field="*{descrizione}" rows="4"></textarea>
            </div>

            <!-- PROCEDIMENTO -->
            <div class="form-group">
                <label for="procedimento">Procedimento</label>
                <textarea id="procedimento" th:field="*{procedimento}" rows="6"></textarea>
            </div>

            <!-- TEMPO -->
            <div class="form-group">
                <label for="tempo">Tempo (minuti)</label>
                <input type="number" id="tempo" th:field="*{tempo}" min="1" />
            </div>

            <!-- DIFFICOLTÀ -->
            <div class="form-group">
                <label for="difficolta">Difficoltà</label>
                <select id="difficolta" th:field="*{difficolta}">
                    <option value="FACILE">Facile</option>
                    <option value="MEDIA">Media</option>
                    <option value="DIFFICILE">Difficile</option>
                </select>
            </div>

            <!-- CATEGORIA -->
            <div class="form-group">
                <label for="categoria">Categoria</label>
                <input type="text" id="categoria" th:field="*{categoria}" />
            </div>

            <!-- INGREDIENTI -->
            <h3 class="section-title">Ingredienti</h3>

            <div id="ingredienti-container">
                <div th:each="ing, iter : ${ricetta.ingredienti}" class="ingrediente-item">

                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" th:field="*{ingredienti[__${iter.index}__].nome}" />
                    </div>

                    <div class="form-group">
                        <label>Quantità</label>
                        <input type="number" th:field="*{ingredienti[__${iter.index}__].quantita}" />
                    </div>

                    <div class="form-group">
                        <label>Unità</label>
                        <input type="text" th:field="*{ingredienti[__${iter.index}__].unita}" />
                    </div>

                    <button type="button" class="remove-btn" onclick="rimuoviIngrediente(this)">Rimuovi</button>

                    <hr>
                </div>
            </div>

            <button type="button" class="btn" onclick="aggiungiIngrediente()">Aggiungi ingrediente</button>

            <div class="btn-container">
                <button type="submit" class="btn">Salva modifiche</button>
            </div>

        </form>

        <a th:href="@{'/ricetta/' + ${ricetta.id}}" class="back-link">Annulla e torna alla ricetta</a>

    </div>
</div>


<!-- SCRIPT -->
<script>
function aggiungiIngrediente() {
    const container = document.getElementById("ingredienti-container");
    const items = container.querySelectorAll(".ingrediente-item");

    const last = items[items.length - 1];
    const clone = last.cloneNode(true);

    clone.querySelectorAll("input").forEach(input => {
        input.value = "";
    });

    container.appendChild(clone);
    rinumeraIngredienti();
}

function rimuoviIngrediente(button) {
    const item = button.closest(".ingrediente-item");
    item.remove();
    rinumeraIngredienti();
}

function rinumeraIngredienti() {
    const items = document.querySelectorAll(".ingrediente-item");

    items.forEach((item, index) => {
        item.querySelectorAll("input").forEach(input => {

            if (input.name) {
                const base = input.name.substring(0, input.name.indexOf("["));
                const field = input.name.substring(input.name.indexOf("]") + 1);
                input.name = base + "[" + index + "]" + field;
            }

            if (input.id) {
                input.id = input.id.replace(/\d+/, index);
            }
        });
    });
}
</script>

</body>
</html>
